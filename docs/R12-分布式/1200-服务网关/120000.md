# 网关鉴权

在多服务架构下，用户需访问多个业务模块，如订单、用户、支付等系统。若各系统独立认证，不仅体验割裂、开发成本高，还容易产生安全隐患。为此，需引入统一的 API 网关 + SSO + Redis 权限缓存 模式，实现以下目标：
✅ 用户只需登录一次，所有服务可无缝访问。
✅ 通过网关实现统一鉴权、权限拦截、请求路由。
✅ 利用 Redis 缓存权限与 Token，提高性能，减轻后端压力。
✅ 提供灵活的权限体系，支持动态刷新与扩展。

## 系统架构

```lua
+------------+         +-----------+          +-------------+
|   Client   | ----->  |  网关服务  |  ----->  |   业务系统    |
+------------+         +-----------+          +-------------+
                            |
                            v
                    +---------------+
                    |   鉴权模块    |
                    +---------------+
                            |
          +----------------+----------------+
          |                                 |
          v                                 v
   +-------------+                  +---------------+
   |     Redis    | <--------->     |     单点登录     |
   +-------------+                  +---------------+
                                         |
                                         v
                                  +-------------+
                                  |  用户中心  |
                                  +-------------+

```

## 功能说明
1. 统一登录流程
用户访问 /login，由 API 网关白名单放行至 SSO 系统。

SSO 系统校验用户信息，通过后生成 Token（如 JWT），设置过期时间。

同时调用 用户中心 拉取权限（角色/菜单/按钮级权限），缓存入 Redis。

最终响应包含 Token，由前端存储（如 Header、Cookie）。

2. 统一鉴权流程
网关拦截所有业务请求，提取 Header 中的 Token。

查询 Redis 中 token:{token} 是否存在。

如果 Token 失效，返回 401 Unauthorized。

查询 Redis 中 auth:{uid} 是否存在。

若无权限缓存，返回 403 Forbidden。

鉴权通过后，将请求转发至对应业务服务。

## 时序图

```
@startuml
actor User
participant "API Gateway" as Gateway
participant "SSO 登录服务" as SSO
participant "用户中心 UC" as UC
participant Redis
participant "业务系统" as Biz

== 首次登录流程 ==
User -> Gateway : POST /login
Gateway -> SSO : 放行请求
SSO -> SSO : 验证账号密码
SSO -> Redis : 存储 token:xxx (设置TTL)
SSO -> UC : 查询用户权限信息
UC --> SSO : 返回权限列表
SSO -> Redis : 存储 auth:uid 权限信息
SSO --> User : 返回 Token

== 接口访问鉴权 ==
User -> Gateway : 请求业务接口 (携带Token)
Gateway -> Redis : 查询 token:xxx 是否存在
alt Token 有效
    Gateway -> Redis : 查询 auth:uid 是否存在
    alt 权限存在
        Gateway -> Biz : 转发请求
        Biz --> User : 返回业务响应
    else 权限不存在
        Gateway --> User : 403 Forbidden
    end
else Token 无效
    Gateway --> User : 401 Unauthorized
end
@enduml

```