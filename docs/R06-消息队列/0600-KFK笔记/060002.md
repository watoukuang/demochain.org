# 参数详解

以下是Kafka常见参数配置的详细解析，按照组件分类并标注关键场景的使用建议：

---

### **一、生产者（Producer）配置**

| 参数 | 默认值 | 说明 | 推荐值（金融场景） | 注意事项 |
|------|--------|------|-------------------|----------|
| `bootstrap.servers` | - | Kafka集群地址列表 | 至少配置3个broker地址 | 建议配置全部broker提高容错 |
| `acks` | 1 | 消息确认机制<br>0=不等待<br>1=leader确认<br>all=所有ISR确认 | `all` | 强一致性场景必须设为`all` |
| `retries` | 2147483647 | 发送失败重试次数 | `Integer.MAX_VALUE` | 需配合`max.in.flight...=1`使用 |
| `max.in.flight.requests.per.connection` | 5 | 单个连接未确认请求数 | `1` | 保证顺序性时必须设为1 |
| `enable.idempotence` | false | 是否启用幂等 | `true` | 需`retries>0`且`acks=all` |
| `compression.type` | none | 压缩算法<br>(none/gzip/snappy/lz4/zstd) | `lz4` | 平衡CPU和带宽消耗 |
| `linger.ms` | 0 | 消息发送延迟时间 | `5` | 提高吞吐但增加延迟 |
| `batch.size` | 16384 | 批次大小(字节) | `65536` | 根据消息大小调整 |
| `request.timeout.ms` | 30000 | 请求超时时间 | `60000` | 网络不稳定时调高 |
| `max.block.ms` | 60000 | 缓冲区满时阻塞时间 | `30000` | 避免长时间阻塞 |

---

### **二、消费者（Consumer）配置**

| 参数 | 默认值 | 说明 | 推荐值 | 注意事项 |
|------|--------|------|-------|----------|
| `group.id` | - | 消费者组ID | 按业务命名 | 必须唯一 |
| `auto.offset.reset` | latest | 无偏移量时策略<br>(earliest/latest/none) | `earliest` | 避免消息丢失 |
| `enable.auto.commit` | true | 自动提交偏移量 | `false` | 严格场景手动提交 |
| `auto.commit.interval.ms` | 5000 | 自动提交间隔 | - | 手动提交时无效 |
| `isolation.level` | read_uncommitted | 事务隔离级别 | `read_committed` | 事务消息必设 |
| `max.poll.records` | 500 | 单次poll最大消息数 | `100` | 控制处理批次 |
| `max.poll.interval.ms` | 300000 | poll间隔超时时间 | `600000` | 长时间处理需调大 |
| `session.timeout.ms` | 10000 | 会话超时时间 | `30000` | 心跳检测间隔 |
| `heartbeat.interval.ms` | 3000 | 心跳发送间隔 | `5000` | 需小于`session.timeout.ms` |

---

### **三、Broker服务端配置**

| 参数 | 默认值 | 说明 | 推荐值 | 注意事项 |
|------|--------|------|-------|----------|
| `log.dirs` | /tmp/kafka-logs | 数据存储目录 | 多磁盘路径逗号分隔 | 提高IO吞吐 |
| `num.partitions` | 1 | 默认分区数 | 根据业务需求 | 创建topic时可覆盖 |
| `default.replication.factor` | 1 | 默认副本数 | `3` | 生产环境≥2 |
| `min.insync.replicas` | 1 | 最小同步副本数 | `2` | 需`replication.factor≥3` |
| `unclean.leader.election.enable` | true | 允许非ISR成为leader | `false` | 避免数据丢失 |
| `log.retention.hours` | 168 | 数据保留时间 | `24` | 根据存储需求调整 |
| `log.retention.bytes` | -1 | 分区最大容量 | `10737418240`(10GB) | 需监控磁盘 |
| `message.max.bytes` | 1000012 | 单条消息最大值 | `10485760`(10MB) | 需同步调整消费者配置 |

---

### **四、Topic级别配置**

| 参数 | 默认值 | 说明 | 推荐值 |
|------|--------|------|-------|
| `cleanup.policy` | delete | 清理策略<br>(delete/compact) | `delete` |
| `retention.ms` | 604800000 | 保留时间(ms) | `86400000`(1天) |
| `segment.bytes` | 1073741824 | 分段文件大小 | `536870912`(512MB) |
| `max.message.bytes` | 1000012 | 单消息最大字节 | 与broker配置一致 |

---

### **五、关键场景配置模板**

#### 1. **金融交易场景（强顺序性）**
```properties
# Producer
acks=all
enable.idempotence=true
max.in.flight.requests.per.connection=1
compression.type=lz4

# Consumer
isolation.level=read_committed
enable.auto.commit=false
auto.offset.reset=earliest

# Broker
min.insync.replicas=2
unclean.leader.election.enable=false
```

#### 2. **日志收集场景（高吞吐）**
```properties
# Producer
acks=1
compression.type=snappy
linger.ms=20
batch.size=32768

# Broker
log.retention.hours=72
num.io.threads=8
```

---

### **六、监控与调优建议**

1. **关键指标监控**：
   - 生产者：`record-error-rate`, `request-latency-avg`
   - 消费者：`records-lag-max`, `poll-rate`
   - Broker：`UnderReplicatedPartitions`, `ActiveControllerCount`

2. **性能调优工具**：
   ```bash
   # 生产者性能测试
   kafka-producer-perf-test \
     --topic test \
     --num-records 1000000 \
     --record-size 1024 \
     --throughput -1 \
     --producer-props bootstrap.servers=localhost:9092

   # 消费者偏移量检查
   kafka-consumer-groups \
     --bootstrap-server localhost:9092 \
     --describe \
     --group my-group
   ```

3. **参数关联性**：
   - `linger.ms` ↑ + `batch.size` ↑ → 吞吐量↑ 但延迟↑
   - `num.io.threads` ↑ → 网络IO处理能力↑
   - `log.flush.interval.messages` ↓ → 数据安全性↑ 但性能↓

---

通过合理配置这些参数，可以在 **消息顺序性**、**可靠性** 和 **吞吐量** 之间取得最佳平衡。建议在生产环境进行压测后最终确定参数值。